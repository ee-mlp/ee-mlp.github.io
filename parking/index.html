<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Tallinn Parking v0.2.5</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  #map { height: 100%; width: 100%; }
  #layers-control {
    position: absolute;
    top: 10px; left: 10px;
    z-index: 10;
    background: white;
    padding: 8px;
    border-radius: 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-family: Arial, sans-serif;
  }
  #layers-control div.version { font-size: 12px; color: #555; margin-top: 4px; }
</style>
</head>
<body>

<div id="layers-control">
  <label><input type="checkbox" id="europarkToggle" checked> EuroPark</label><br>
  <label><input type="checkbox" id="snabbToggle" checked> Snabb</label><br>
  <label><input type="checkbox" id="yhisteenusedToggle" checked> Yhisteenused</label>
  <div class="version">Version: v0.2.5</div>
</div>

<div id="map"></div>

<script>
let map;
let globalClusterer;
let infoWindow;
const APP_VERSION = "v0.2.5";

// Layer container
const layers = {
  europark: { markers: [], polygons: [], visible: true },
  snabb: { markers: [], polygons: [], visible: true },
  yhisteenused: { markers: [], polygons: [], visible: true }
};

let snabbDetailMap = {};
let yhisteenusedDetailMap = {};

// Marker creation
function createParkingMarker(lat, lng, layerName, labelText = "P") {
  const colorMap = {
    europark: "#000000",       // black
    snabb: "#FFD700",           // yellow
    yhisteenused: "#1E90FF"    // blue
  };

  const div = document.createElement("div");
  div.style.background = colorMap[layerName] || "#000";
  div.style.color = layerName === "snabb" ? "#000" : "#fff"; // contrast
  div.style.fontWeight = "bold";
  div.style.fontSize = "18px";
  div.style.width = "40px";
  div.style.height = "40px";
  div.style.borderRadius = "50%";
  div.style.display = "flex";
  div.style.alignItems = "center";
  div.style.justifyContent = "center";
  div.style.border = "2px solid #333";
  div.innerText = labelText;

  return new google.maps.marker.AdvancedMarkerElement({
    position: { lat, lng },
    content: div
  });
}

// Add marker to layer and cluster
function addMarkerToLayer(layerName, marker) {
  layers[layerName].markers.push(marker);
  marker.map = layers[layerName].visible ? map : null;
  if (globalClusterer) globalClusterer.addMarker(marker);
}

// Toggle layer visibility
function setLayerVisible(layerName, visible) {
  layers[layerName].visible = visible;
  layers[layerName].markers.forEach(m => m.map = visible ? map : null);
  layers[layerName].polygons.forEach(p => p.setMap(visible ? map : null));
  if (globalClusterer) globalClusterer.repaint();
}

// Initialize map
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 59.437, lng: 24.753 },
    zoom: 13,
    mapId: "PARKING_MAP_ID"
  });

  infoWindow = new google.maps.InfoWindow();
  globalClusterer = new markerClusterer.MarkerClusterer({ map });

  loadEuroPark();
  loadSnabb();
  loadYhisteenused();

  document.getElementById("europarkToggle").addEventListener("change", e => setLayerVisible("europark", e.target.checked));
  document.getElementById("snabbToggle").addEventListener("change", e => setLayerVisible("snabb", e.target.checked));
  document.getElementById("yhisteenusedToggle").addEventListener("change", e => setLayerVisible("yhisteenused", e.target.checked));
}

// Load EuroPark
async function loadEuroPark() {
  try {
    const res = await fetch("https://mlp.ee/parking/europark.json");
    const data = await res.json();
    data.paringzones.forEach(zone => {
      const marker = createParkingMarker(parseFloat(zone.latitude), parseFloat(zone.longitude), "europark");
      addMarkerToLayer("europark", marker);

      marker.addListener("click", () => {
        infoWindow.setContent(`<b>${zone.name}</b><br>${zone.address}`);
        infoWindow.open({ anchor: marker, map });
      });

      if (zone.geojson?.features) {
        zone.geojson.features.forEach(f => {
          if (f.geometry.type === "Polygon") {
            const polygon = new google.maps.Polygon({
              paths: f.geometry.coordinates[0].map(c => ({ lat: c[1], lng: c[0] })),
              strokeColor: "#000000",
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: "#000000",
              fillOpacity: 0.1
            });
            polygon.setMap(layers.europark.visible ? map : null);
            layers.europark.polygons.push(polygon);
          }
        });
      }
    });
  } catch(e) { console.error("Failed to load EuroPark", e); }
}

// Load Snabb
async function loadSnabb() {
  try {
    const res = await fetch("https://mlp.ee/parking/snabb.json");
    const data = await res.json();
    const detailRes = await fetch("https://mlp.ee/parking/snabb_detail.json");
    const detailData = await detailRes.json();

    detailData.forEach(d => { snabbDetailMap[d.ID] = d; });

    data.forEach(zone => {
      const marker = createParkingMarker(zone.Latitude, zone.Longitude, "snabb");
      addMarkerToLayer("snabb", marker);

      marker.addListener("click", () => {
        const detail = snabbDetailMap[zone.ID];
        if (detail) {
          let html = `<b>${zone.Name}</b><br>${zone.AddressText}<br>`;
          html += `<b>Half hour:</b> ${detail.HalfHourPrice} ${detail.Currency}<br>`;
          html += `<b>24h:</b> ${detail.Price24h} ${detail.Currency}<br>`;
          if (detail.MonthlyPasses) {
            detail.MonthlyPasses.forEach(p => {
              html += `<b>${p.Name}:</b> ${p.Price} ${detail.Currency}<br>`;
            });
          }
          infoWindow.setContent(html);
          infoWindow.open({ anchor: marker, map });
        }
      });
    });
  } catch(e) { console.error("Failed to load Snabb", e); }
}

// Load Yhisteenused
async function loadYhisteenused() {
  try {
    const res = await fetch("https://mlp.ee/parking/yhisteenused.json");
    const data = await res.json();
    const detailRes = await fetch("https://mlp.ee/parking/yhisteenused_detail.json");
    const detailData = await detailRes.json();

    detailData.forEach(d => { yhisteenusedDetailMap[d.id] = d; });

    data.items.forEach(zone => {
      const marker = createParkingMarker(zone.lat, zone.lng, "yhisteenused");
      addMarkerToLayer("yhisteenused", marker);

      marker.addListener("click", () => {
        const detail = yhisteenusedDetailMap[zone.id];
        if (detail) {
          let html = `<b>${zone.title}</b><br>${zone.address}<br>`;
          if (detail.prices) {
            detail.prices.forEach(p => {
              html += `<b>${p.duration}:</b> ${p.price}<br>`;
            });
          }
          infoWindow.setContent(html);
          infoWindow.open({ anchor: marker, map });
        }
      });
    });
  } catch(e) { console.error("Failed to load Yhisteenused", e); }
}
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA84lYljBvy35HMNdP7_bV3eCBtUQ7ivn4&v=weekly&libraries=marker&callback=initMap">
</script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</body>
</html>
