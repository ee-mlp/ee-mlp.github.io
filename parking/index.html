<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Tallinn Parking Nearby v0.3.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
#map { height: 50%; width: 100%; }
#search-container { padding: 10px; text-align: center; }
#search-box { width: 90%; max-width: 400px; padding: 8px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; }
#table-container { height: 50%; overflow-y: auto; padding: 10px; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 6px; border-bottom: 1px solid #ccc; text-align: left; }
th { background: #f0f0f0; }
tr:hover { background-color: #eef; cursor: pointer; }
a { text-decoration: none; color: inherit; }
</style>
</head>
<body>

<div id="search-container">
  <input id="search-box" type="text" placeholder="Search address...">
</div>

<div id="map"></div>

<div id="table-container">
  <table id="markers-table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Price</th>
        <th>Distance (m)</th>
        <th>Source</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let map;
let infoWindow;
let markersData = [];
let userLocation = null;
let markerObjects = [];

// Preload data
async function preloadData() {
  const euro = await fetch("https://mlp.ee/parking/europark.json").then(r=>r.json()).catch(()=>({paringzones:[]}));
  const euroParkData = euro.paringzones||[];

  const snabb = await fetch("https://mlp.ee/parking/snabb_detail.json").then(r=>r.json()).catch(()=>[]);

  const yh = await fetch("https://mlp.ee/parking/yhisteenused.json").then(r=>r.json()).catch(()=>({items:[]})).then(d=>d.items||[]);
  const yhDetail = await fetch("https://mlp.ee/parking/yhisteenused_detail.json").then(r=>r.json()).catch(()=>[]);

  const yhDetailMap = new Map();
  yhDetail.forEach(d=>yhDetailMap.set(String(d.id), d));

  markersData = [];

  euroParkData.forEach(z=>{
    markersData.push({
      title: z.name,
      price: z.price_list ? z.price_list.map(p=>`${p.period_name_long}: ${p.amount_w_vat/100} ${p.currency}`).join(", ") : "",
      lat: parseFloat(z.latitude),
      lng: parseFloat(z.longitude),
      source: "EuroPark"
    });
  });

  snabb.forEach(z=>{
    markersData.push({
      title: z.Name,
      price: `Iga alustatud 30 minutit: ${z.HalfHourPrice} ${z.Currency}, 24h: ${z.Price24h} ${z.Currency}`,
      lat: z.Latitude,
      lng: z.Longitude,
      source: "Snabb"
    });
  });

  yh.forEach(z=>{
    const detail = yhDetailMap.get(String(z.id));
    let priceText = "";
    if(detail && detail.prices) priceText = detail.prices.map(p=>`${p.duration}: ${p.price}`).join(", ");
    markersData.push({
      title: z.title,
      price: priceText,
      lat: z.lat,
      lng: z.lng,
      source: "Yhisteenused"
    });
  });
}

// Haversine distance
function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const toRad = x => x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

// Update table and map markers
function updateNearby() {
  if(!userLocation) return;
  const tbody = document.querySelector("#markers-table tbody");
  tbody.innerHTML = "";

  // Clear previous markers
  markerObjects.forEach(m=>m.setMap(null));
  markerObjects = [];

  markersData.forEach(m=>{
    m.distance = haversine(userLocation.lat(), userLocation.lng(), m.lat, m.lng);
  });

  // Filter within 1000 m
  const nearby = markersData.filter(m=>m.distance <= 1000).sort((a,b)=>a.distance-b.distance);

  nearby.forEach((m,index)=>{
    const tr = document.createElement("tr");

    // Clickable title for Google Maps navigation
    const titleCell = document.createElement("td");
    const link = document.createElement("a");
    link.textContent = m.title;
    link.href = `https://www.google.com/maps/dir/?api=1&destination=${m.lat},${m.lng}`;
    link.target = "_blank";
    titleCell.appendChild(link);

    const priceCell = document.createElement("td");
    priceCell.textContent = m.price;

    const distanceCell = document.createElement("td");
    distanceCell.textContent = Math.round(m.distance);

    const sourceCell = document.createElement("td");
    sourceCell.textContent = m.source;

    tr.appendChild(titleCell);
    tr.appendChild(priceCell);
    tr.appendChild(distanceCell);
    tr.appendChild(sourceCell);

    // Table row click: pan & info window
    tr.addEventListener("click", ()=>{
      map.panTo({lat: m.lat, lng: m.lng});
      map.setZoom(17);
      infoWindow.setContent(`<b>${m.title}</b><br>${m.price}<br><i>${m.source}</i>`);
      infoWindow.setPosition({lat: m.lat, lng: m.lng});
      infoWindow.open(map);
    });

    tbody.appendChild(tr);

    // Add marker on map
    const color = m.source === "EuroPark" ? "black" : m.source === "Snabb" ? "yellow" : "blue";
    const marker = new google.maps.Marker({
      position: {lat: m.lat, lng: m.lng},
      map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 10,
        fillColor: color,
        fillOpacity: 0.8,
        strokeWeight: 1,
        strokeColor: "white"
      }
    });
    marker.addListener("click", ()=>{
      infoWindow.setContent(`<b>${m.title}</b><br>${m.price}<br><i>${m.source}</i>`);
      infoWindow.open(map, marker);
    });
    markerObjects.push(marker);
  });
}

// Initialize map
async function initMap() {
  await preloadData();

  map = new google.maps.Map(document.getElementById("map"), {
    center: {lat: 59.437, lng: 24.753},
    zoom: 13
  });

  infoWindow = new google.maps.InfoWindow();

  const input = document.getElementById("search-box");
  const searchBox = new google.maps.places.SearchBox(input);
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(input);

  searchBox.addListener("places_changed", () => {
    const places = searchBox.getPlaces();
    if(!places || !places.length) return;
    const p = places[0];
    if(!p.geometry) return;
    userLocation = p.geometry.location;
    map.panTo(userLocation);
    map.setZoom(16);
    updateNearby();
  });

  // Default location via geolocation
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos=>{
      userLocation = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      map.panTo(userLocation);
      map.setZoom(16);
      updateNearby();

      // Show marker for user location
      new google.maps.Marker({
        position: userLocation,
        map,
        title: "You are here",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 8,
          fillColor: "red",
          fillOpacity: 1,
          strokeColor: "white",
          strokeWeight: 2
        }
      });
    }, ()=>{
      userLocation = map.getCenter();
      updateNearby();
    });
  } else {
    userLocation = map.getCenter();
    updateNearby();
  }

  map.addListener("click", e=>{
    userLocation = e.latLng;
    updateNearby();
  });
}
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA84lYljBvy35HMNdP7_bV3eCBtUQ7ivn4&v=weekly&libraries=places&callback=initMap">
</script>
</body>
</html>
