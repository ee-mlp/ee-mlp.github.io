<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tallinn Parking Map</title>
  <style>
    #map { height: 100vh; width: 100%; }
    #layers-control {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 5;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
<div id="layers-control">
  <label><input type="checkbox" id="europarkLayer" checked> EuroPark</label><br>
  <label><input type="checkbox" id="snabbLayer" checked> Snabb</label>
</div>
<div id="map"></div>

<script>
const DATA_SOURCES = {
  europark: "https://mlp.ee/parking/europark.json",
  snabb: "https://mlp.ee/parking/snabb.json",
  snabb_detail: "https://mlp.ee/parking/snabb_detail.json"
};
const CACHE_TTL = 24 * 60 * 60 * 1000;

// -------------------- MapLayer class --------------------
class MapLayer {
  constructor(name) { this.name = name; this.items = []; }
  add(item) { this.items.push(item); }
  setVisible(map, visible) {
    this.items.forEach(item => { if (item.setMap) item.setMap(visible ? map : null); });
  }
}

// -------------------- Caching fetch --------------------
async function fetchCached(url, key) {
  const cached = localStorage.getItem(key);
  if (cached) {
    const parsed = JSON.parse(cached);
    if (Date.now() - parsed.timestamp < CACHE_TTL) return parsed.data;
  }
  const resp = await fetch(url);
  const data = await resp.json();
  localStorage.setItem(key, JSON.stringify({ timestamp: Date.now(), data }));
  return data;
}

// -------------------- Marker & Polygon helpers --------------------
function createMarker(map, position, title, infoContent) {
  const marker = new google.maps.Marker({ map, position, title });
  const infoWindow = new google.maps.InfoWindow({ content: infoContent });
  marker.addListener("click", () => infoWindow.open(map, marker));
  return marker;
}

function createPolygon(map, pathCoords, color="#FF0000") {
  return new google.maps.Polygon({
    paths: pathCoords,
    strokeColor: color,
    strokeOpacity: 0.6,
    strokeWeight: 2,
    fillColor: color,
    fillOpacity: 0.25,
    map
  });
}

// -------------------- EuroPark price formatting --------------------
function formatEuroparkPrice(price_list) {
  if (!price_list || price_list.length === 0) return "No prices";
  return price_list.map(p => `${p.period_name_long}: ${p.amount_w_vat/100} ${p.currency}`).join("<br>");
}

// -------------------- Init Map --------------------
async function initMap() {
  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 59.437, lng: 24.753 },
    zoom: 13
  });

  // === Layers ===
  const euroLayer = new MapLayer("EuroPark");
  const snabbLayer = new MapLayer("Snabb");

  // --- EURO PARK ---
  const euroData = await fetchCached(DATA_SOURCES.europark, "europark_cache");
  euroData?.paringzones?.forEach(zone => {
    // Marker at centerpoint
    const center = zone.geojson?.features?.find(f => f.properties?.type==="centerpoint");
    if (center) {
      const [lng, lat] = center.geometry.coordinates;
      const content = `<b>${zone.name}</b><br>${zone.address}<br>
                       Available: ${zone.available_spaces}<br>
                       <a href="${zone.url}" target="_blank">More info</a><br>
                       <b>Prices:</b><br>${formatEuroparkPrice(zone.price_list)}`;
      euroLayer.add(createMarker(map, {lat,lng}, zone.name, content));
    }
    // Polygons
    zone.geojson?.features?.filter(f => f.properties?.type==="outline").forEach(f => {
      const coords = f.geometry.coordinates[0].map(c => ({lat:c[1], lng:c[0]}));
      euroLayer.add(createPolygon(map, coords, "#0000FF"));
    });
  });

  // --- SNABB ---
  const snabbData = await fetchCached(DATA_SOURCES.snabb, "snabb_cache");
  snabbData?.forEach(item => {
    const lat = parseFloat(item.Latitude);
    const lng = parseFloat(item.Longitude);
    if (!lat || !lng) return;
    const content = `<b>${item.Name}</b><br>${item.AddressText}<br>Zone: ${item.Zone}`;
    snabbLayer.add(createMarker(map, {lat,lng}, item.Name, content));
  });

  const snabbDetailData = await fetchCached(DATA_SOURCES.snabb_detail, "snabb_detail_cache");
  snabbDetailData?.forEach(item => {
    const lat = parseFloat(item.Latitude);
    const lng = parseFloat(item.Longitude);
    if (!lat || !lng) return;

    const content = `<b>${item.Name}</b><br>${item.AddressText}<br>
                     Zone: ${item.Zone}<br>
                     24h price: ${item.Price24h} ${item.Currency}<br>
                     Half-hour: ${item.HalfHourPrice} ${item.Currency}`;
    snabbLayer.add(createMarker(map, {lat,lng}, item.Name, content));

    // Polygons
    item.Polygons?.forEach(poly => {
      const pathCoords = poly.path.map(pt => ({lat:pt.latitude,lng:pt.longitude}));
      snabbLayer.add(createPolygon(map, pathCoords, "#008800"));
    });
  });

  // === Layer toggles ===
  document.getElementById("europarkLayer").addEventListener("change", e => {
    euroLayer.setVisible(map, e.target.checked);
  });
  document.getElementById("snabbLayer").addEventListener("change", e => {
    snabbLayer.setVisible(map, e.target.checked);
  });
}
</script>

<!-- Google Maps API -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA84lYljBvy35HMNdP7_bV3eCBtUQ7ivn4&callback=initMap">
</script>
</body>
</html>
