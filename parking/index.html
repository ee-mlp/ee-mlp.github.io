<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tallinn EuroPark Map</title>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const DATA_URL = "https://mlp.ee/parking/europark.json";
    const CACHE_KEY = "europark_cache";
    const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours

    async function loadParkingData() {
      // Check cache
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        const parsed = JSON.parse(cached);
        if (Date.now() - parsed.timestamp < CACHE_TTL) {
          console.log("Loaded EuroPark data from cache");
          return parsed.data;
        }
      }

      // Fetch from network
      const response = await fetch(DATA_URL);
      const data = await response.json();

      // Cache it
      localStorage.setItem(CACHE_KEY, JSON.stringify({
        timestamp: Date.now(),
        data: data
      }));

      console.log("Fetched EuroPark data from network");
      return data;
    }

    function formatPriceSummary(price_list) {
      if (!price_list || price_list.length === 0) return "No prices";
      return price_list.map(p => `${p.period_name_long}: ${p.amount_w_vat/100} ${p.currency}`).join("<br>");
    }

    function initMap() {
      const map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 59.437, lng: 24.753 },
        zoom: 13
      });

      loadParkingData().then(data => {
        if (!data || !data.paringzones) return;

        data.paringzones.forEach(zone => {
          const lat = parseFloat(zone.latitude);
          const lng = parseFloat(zone.longitude);

          if (!lat || !lng) return;

          const marker = new google.maps.Marker({
            position: { lat, lng },
            map: map,
            title: zone.name
          });

          const infoWindow = new google.maps.InfoWindow({
            content: `
              <b>${zone.name}</b><br>
              ${zone.address}<br>
              Available spaces: ${zone.available_spaces}<br>
              <a href="${zone.url}" target="_blank">More info</a><br>
              <b>Prices:</b><br>${formatPriceSummary(zone.price_list)}
            `
          });

          marker.addListener("click", () => infoWindow.open(map, marker));
        });
      });
    }
  </script>

  <!-- Replace YOUR_API_KEY with your Google Maps API key -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA84lYljBvy35HMNdP7_bV3eCBtUQ7ivn4&callback=initMap">
  </script>
</body>
</html>
