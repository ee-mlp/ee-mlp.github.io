<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Tallinn Parking v0.3.5</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html, body { height: 100%; margin: 0; padding: 0; }
#map { height: 100%; width: 100%; }

/* Layers panel */
#layers-control {
  position: absolute;
  bottom: 80px;
  left: 10px;
  z-index: 10;
  background: rgba(255,255,255,0.95);
  padding: 8px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-family: Arial, sans-serif;
  font-size: 14px;
}
#layers-control div.version { font-size: 12px; color: #555; margin-top: 4px; }

/* Search box */
#search-box {
  position: absolute;
  top: 10%; /* lowered 10% from top */
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 400px;
  z-index: 10;
  font-size: 16px;
  padding: 8px 12px;
  border-radius: 4px;
  border: 1px solid #ccc;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* Crosshairs button */
#geolocate-btn {
  position: absolute;
  bottom: 10px;
  right: 12%; /* shifted 2% to right */
  z-index: 10;
  width: 48px;
  height: 48px;
  background:white;
  border-radius:50%;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
}

@media(max-width:600px){
  #layers-control { font-size:12px; padding:6px; }
  #search-box { font-size:14px; padding:6px 10px; }
  #geolocate-btn { width:40px; height:40px; font-size:20px; }
}
</style>
</head>
<body>

<input id="search-box" type="text" placeholder="Search address">
<div id="geolocate-btn">üìç</div>

<div id="layers-control">
  <label><input type="checkbox" id="europarkToggle" checked> EuroPark</label><br>
  <label><input type="checkbox" id="snabbToggle" checked> Snabb</label><br>
  <label><input type="checkbox" id="yhisteenusedToggle" checked> Yhisteenused</label>
  <div class="version">Version: v0.3.5</div>
</div>

<div id="map"></div>

<script>
let map;
let globalClusterer;
let infoWindow;
let userLocationMarker = null;

const layers = {
  europark: { markers: [], polygons: [], visible: true },
  snabb: { markers: [], polygons: [], visible: true },
  yhisteenused: { markers: [], polygons: [], visible: true }
};

let euroParkData = [];
let snabbDetailData = [];
let yhisteenusedData = [];
let yhisteenusedDetailMap = new Map();

// Fetch & cache helper
async function fetchAndCache(url,key,maxAge=3600000){
  try{
    const cached = localStorage.getItem(key);
    if(cached){
      const parsed = JSON.parse(cached);
      if(Date.now()-parsed.timestamp<maxAge) return parsed.data;
    }
    const res = await fetch(url);
    const data = await res.json();
    localStorage.setItem(key, JSON.stringify({data, timestamp:Date.now()}));
    return data;
  }catch(e){console.error("Fetch/cache error:",e); return null;}
}

async function preloadData(){
  const euro = await fetchAndCache("https://mlp.ee/parking/europark.json","cache_europark");
  euroParkData = euro?.paringzones||[];

  snabbDetailData = await fetchAndCache("https://mlp.ee/parking/snabb_detail.json","cache_snabb_detail")||[];

  const yh = await fetchAndCache("https://mlp.ee/parking/yhisteenused.json","cache_yhisteenused");
  yhisteenusedData = yh?.items||[];

  const yhDetail = await fetchAndCache("https://mlp.ee/parking/yhisteenused_detail.json","cache_yhisteenused_detail")||[];
  yhDetail.forEach(d=>yhisteenusedDetailMap.set(String(d.id),d));
}

// Create SVG "P" marker
function createParkingMarker(lat,lng,layer){
  const colors = { europark:"#000", snabb:"#FFD700", yhisteenused:"#1E90FF" };

  return new google.maps.Marker({
    position: {lat,lng},
    icon: {
      url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
          <circle cx="20" cy="20" r="20" fill="${colors[layer]}" />
          <text x="20" y="26" font-size="18" font-weight="bold" text-anchor="middle" fill="white">P</text>
        </svg>
      `),
      scaledSize: new google.maps.Size(40,40),
    }
  });
}

function addMarkerToLayer(layer,marker){
  layers[layer].markers.push(marker);
  marker.setMap(layers[layer].visible?map:null);
  if(globalClusterer) globalClusterer.addMarker(marker);
}

function setLayerVisible(layer,visible){
  layers[layer].visible=visible;
  layers[layer].markers.forEach(m=>m.setMap(visible?map:null));
  layers[layer].polygons.forEach(p=>p.setMap(visible?map:null));
  if(globalClusterer) globalClusterer.repaint();
}

// EuroPark markers
function createEuroParkMarkers(){
  euroParkData.forEach(zone=>{
    const marker=createParkingMarker(parseFloat(zone.latitude),parseFloat(zone.longitude),"europark");
    addMarkerToLayer("europark",marker);
    marker.addListener("click",()=>{
      let html=`<b>${zone.name}</b><br>${zone.address}<br>`;
      if(zone.price_list) {
        html+="<b>Prices:</b><br>";
        zone.price_list.forEach(p=>html+=`${p.period_name_long}: ${p.amount_w_vat/100} ${p.currency}<br>`);
      }
      infoWindow.setContent(html);
      infoWindow.open(map,marker);
    });
  });
}

// Snabb markers
function createSnabbMarkers(){
  snabbDetailData.forEach(zone=>{
    const marker=createParkingMarker(zone.Latitude,zone.Longitude,"snabb");
    addMarkerToLayer("snabb",marker);
    marker.addListener("click",()=>{
      let html=`<b>${zone.Name}</b><br>${zone.AddressText}<br>`;
      html+=`<b>Half hour:</b> ${zone.HalfHourPrice} ${zone.Currency}<br>`;
      html+=`<b>24h:</b> ${zone.Price24h} ${zone.Currency}<br>`;
      if(zone.MonthlyPasses) zone.MonthlyPasses.forEach(p=>html+=`<b>${p.Name}:</b> ${p.Price} ${zone.Currency}<br>`);
      infoWindow.setContent(html);
      infoWindow.open(map,marker);
    });
  });
}

// Yhisteenused markers
function createYhisteenusedMarkers(){
  yhisteenusedData.forEach(zone=>{
    const marker=createParkingMarker(zone.lat,zone.lng,"yhisteenused");
    addMarkerToLayer("yhisteenused",marker);
    marker.addListener("click",()=>{
      const detail=yhisteenusedDetailMap.get(String(zone.id));
      if(detail){
        let html=`<b>${zone.title}</b><br>${zone.address}<br>`;
        detail.prices.forEach(p=>html+=`<b>${p.duration}:</b> ${p.price}<br>`);
        infoWindow.setContent(html);
        infoWindow.open(map,marker);
      }
    });
  });
}

// Initialize map
async function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{
    center:{lat:59.437,lng:24.753},
    zoom:13,
    mapId:"PARKING_MAP_ID"
  });
  infoWindow=new google.maps.InfoWindow();
  
  await preloadData();
  
  createEuroParkMarkers();
  createSnabbMarkers();
  createYhisteenusedMarkers();
  
  globalClusterer=new markerClusterer.MarkerClusterer({map});
  Object.values(layers).forEach(layer=>layer.markers.forEach(m=>globalClusterer.addMarker(m)));

  // Layer toggles
  document.getElementById("europarkToggle").addEventListener("change",e=>setLayerVisible("europark",e.target.checked));
  document.getElementById("snabbToggle").addEventListener("change",e=>setLayerVisible("snabb",e.target.checked));
  document.getElementById("yhisteenusedToggle").addEventListener("change",e=>setLayerVisible("yhisteenused",e.target.checked));

  // Address search box
  const input = document.getElementById("search-box");
  const searchBox = new google.maps.places.SearchBox(input);
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(input);
  searchBox.addListener("places_changed",()=>{
    const places = searchBox.getPlaces();
    if(places.length===0) return;
    const p = places[0];
    if(!p.geometry) return;
    map.panTo(p.geometry.location);
    map.setZoom(16);
  });

  // Close infoWindow when clicking on the map
  map.addListener("click", () => {
    if (infoWindow) infoWindow.close();
  });

  // Geolocation button
  const geolocateBtn = document.getElementById("geolocate-btn");
  map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(geolocateBtn);
  geolocateBtn.addEventListener("click",()=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const loc={lat:pos.coords.latitude,lng:pos.coords.longitude};
        map.panTo(loc);
        map.setZoom(16);

        if(userLocationMarker) userLocationMarker.setMap(null);

        userLocationMarker = new google.maps.Marker({
          position: loc,
          map: map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor:"#FF0000",
            fillOpacity:1,
            strokeColor:"#fff",
            strokeWeight:2
          }
        });
        userLocationMarker.addListener("click",()=>{ if(infoWindow) infoWindow.close(); });
      }, err=>{ alert("Geolocation failed"); });
    } else { alert("Geolocation not supported"); }
  });
}
</script>

<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA84lYljBvy35HMNdP7_bV3eCBtUQ7ivn4&v=weekly&libraries=marker,places&callback=initMap">
</script>
</body>
</html>
